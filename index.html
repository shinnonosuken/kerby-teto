<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Star Drop Blocks - Simple Tetris-like</title>
<style>
  /* ====== ãƒ™ãƒ¼ã‚¹UIï¼ˆã‚·ãƒ³ãƒ—ãƒ«ã§è¦‹ã‚„ã™ã„ãƒ»ã‚¹ãƒãƒ›å¯¾å¿œï¼‰ ====== */
  :root{
    --bg:#fde6f2;         /* ãµã‚“ã‚ã‚Šãƒ”ãƒ³ã‚¯ */
    --panel:#ffffffdd;    /* åŠé€æ˜ãƒ‘ãƒãƒ« */
    --ink:#4b2b3f;        /* æ–‡å­—è‰²ï¼ˆæ·±ã„ç´«ï¼‰ */
    --accent:#ff77b7;     /* å¼·èª¿ */
    --accent2:#8ae1ff;    /* è£œåŠ©ã‚¢ã‚¯ã‚»ãƒ³ãƒˆ */
  }
  html,body{
    margin:0; height:100%; background: radial-gradient(circle at 20% 15%, #fff6, transparent 40%),
                               radial-gradient(circle at 80% 70%, #fff6, transparent 35%),
                               var(--bg);
    color:var(--ink); font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", sans-serif;
    touch-action: none; /* ãƒ¢ãƒã‚¤ãƒ«ã§ã®ç”»é¢ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«èª¤çˆ†ã‚’æŠ‘åˆ¶ */
  }
  .wrap{
    display:flex; flex-direction:column; align-items:center; gap:10px; padding:10px 8px 90px;
    min-height:100%;
  }
  h1{ font-size:1.1rem; margin:10px 0 0; letter-spacing:.02em; }
  .hud{
    display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:center;
    background:var(--panel); border-radius:16px; padding:6px 10px; box-shadow:0 6px 16px #00000014;
  }
  .badge{ padding:4px 8px; border-radius:999px; background:#fff; box-shadow: inset 0 1px 0 #ffffffcc; }
  .board-wrap{
    position:relative; display:flex; gap:10px; align-items:flex-start; justify-content:center;
  }
  canvas{
    background:
      /* ã»ã‚“ã®ã‚Šæ˜ŸæŸ„ */
      radial-gradient(circle at 10% 20%, #fff8 0 2px, transparent 3px),
      radial-gradient(circle at 70% 30%, #fff8 0 2px, transparent 3px),
      radial-gradient(circle at 30% 80%, #fff8 0 2px, transparent 3px),
      #fefbff;
    border-radius:14px; box-shadow:0 10px 24px #0000001a, inset 0 2px 0 #ffffffcc;
    image-rendering: pixelated; /* ãƒ¬ãƒˆãƒ­æ„Ÿï¼‹ã«ã˜ã¿é˜²æ­¢ */
  }
  .side{
    background:var(--panel); border-radius:16px; padding:8px; width:120px; box-shadow:0 6px 16px #00000014;
  }
  .side h3{ font-size:.9rem; margin:.2rem 0 .4rem; }
  .mini{
    width:100%; aspect-ratio:1/1; background:#fff; border-radius:10px; box-shadow: inset 0 2px 0 #ffffffcc;
  }

  /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒœã‚¿ãƒ³ç¾¤ï¼ˆå›ºå®šãƒ•ãƒƒã‚¿ãƒ¼ï¼‰ */
  .pad{
    position:fixed; left:0; right:0; bottom:0; backdrop-filter:blur(6px);
    background:linear-gradient(180deg, #ffffffaa, #ffffffee);
    padding:8px; display:grid; gap:8px; grid-template-columns:repeat(6,1fr);
    box-shadow:0 -6px 16px #0000001a; z-index:10;
  }
  .btn{
    -webkit-tap-highlight-color: transparent;
    user-select:none; touch-action:manipulation; text-align:center; font-weight:700;
    padding:10px 8px; border-radius:12px; border:0; background:#fff;
    box-shadow:0 6px 12px #00000014, inset 0 2px 0 #ffffffcc;
  }
  .btn:active{ transform:translateY(1px); }
  .btn.accent{ background:linear-gradient(180deg, #fff, #ffe7f3); color:#b30066; }
  .btn.accent2{ background:linear-gradient(180deg, #fff, #e6f9ff); color:#005b77; }
  .overlay{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    background:#00000033; border-radius:14px; color:#fff; text-align:center; padding:20px;
  }
  .card{
    background:#ffffffee; color:var(--ink); border-radius:16px; padding:16px; max-width:420px;
    box-shadow:0 10px 24px #00000026;
  }
  .card h2{ margin:.2rem 0 .6rem; }
  .muted{ opacity:.7; font-size:.9rem; }
  .sr{ position:absolute; left:-9999px; width:1px; height:1px; overflow:hidden; }

  @media (min-width: 800px){
    .wrap{ padding-bottom:30px; }
    .pad{ display:none; } /* PCã§ã¯ãƒ•ãƒƒã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã‚’éš ã™ */
  }
</style>
</head>
<body>
  <div class="wrap">
    <h1>ğŸŒŸ Star Drop Blocks</h1>
    <div class="hud" aria-live="polite">
      <div class="badge" id="stage">Stage 1</div>
      <div class="badge" id="target">Target: 10 lines</div>
      <div class="badge" id="lines">Lines: 0</div>
      <div class="badge" id="score">Score: 0</div>
      <div class="badge" id="status">Ready</div>
    </div>

    <div class="board-wrap">
      <canvas id="game" width="300" height="600" aria-label="Game board" role="img"></canvas>
      <div class="side">
        <h3>Next</h3>
        <canvas id="next" class="mini" width="120" height="120"></canvas>
        <h3>Hold</h3>
        <canvas id="hold" class="mini" width="120" height="120"></canvas>
        <button id="btnStart" class="btn accent" style="width:100%; margin-top:8px;">â–¶ï¸ Start</button>
        <button id="btnPause" class="btn" style="width:100%; margin-top:6px;">â¸ Pause</button>
        <button id="btnRestart" class="btn" style="width:100%; margin-top:6px;">â†» Restart</button>
        <p class="muted" style="margin:.6rem 0 0;">PC: â†â†’ç§»å‹• / â†‘,Z,Xå›è»¢ / â†“åŠ é€Ÿ / Spaceè½ä¸‹ / Pä¸€æ™‚åœæ­¢ / Rå†é–‹</p>
      </div>

      <!-- åˆæœŸã‚¬ã‚¤ãƒ‰ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆã™ãéŠã¹ã‚‹å°ç·šï¼‰ -->
      <div id="overlay" class="overlay" style="display:flex;">
        <div class="card">
          <h2>10ãƒ©ã‚¤ãƒ³æ¶ˆã—ãŸã‚‰ã‚¯ãƒªã‚¢ï¼</h2>
          <p>ãƒ–ãƒ­ãƒƒã‚¯ã‚’å›è»¢ãƒ»ç§»å‹•ã—ã¦æ¨ªä¸€åˆ—ã‚’ãã‚ãˆã‚ˆã†ã€‚</p>
          <ul style="margin:.5rem 0 .2rem;">
            <li>PCï¼šâ† â†’ / â†‘ Z X / â†“ / Space / P</li>
            <li>ã‚¹ãƒãƒ›ï¼šç”»é¢ä¸‹ã®ãƒœã‚¿ãƒ³ã§æ“ä½œ</li>
          </ul>
          <p class="muted">ã„ã¤ã§ã‚‚ã€Œâ–¶ï¸ Startã€ã§é–‹å§‹ã§ãã¾ã™ã€‚</p>
          <button class="btn accent" id="overlayStart">â–¶ï¸ Start</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ãƒ¢ãƒã‚¤ãƒ«æ“ä½œãƒ‘ãƒƒãƒ‰ï¼ˆé•·æŠ¼ã—é€£æ‰“å¯¾å¿œï¼‰ -->
  <div class="pad" id="pad">
    <button class="btn" data-action="left" aria-label="Left">â—€ï¸</button>
    <button class="btn" data-action="right" aria-label="Right">â–¶ï¸</button>
    <button class="btn accent2" data-action="rotL" aria-label="Rotate Left">âŸ²</button>
    <button class="btn accent2" data-action="rotR" aria-label="Rotate Right">âŸ³</button>
    <button class="btn" data-action="soft" aria-label="Soft Drop">â†“</button>
    <button class="btn accent" data-action="hard" aria-label="Hard Drop">â¤“</button>
  </div>

<script>
/* ==========================================================
   Star Drop Blocks - å˜ä¸€HTMLç‰ˆ
   å®Ÿè£…æ„å›³ã®è¦ç´„ï¼ˆå¯èª­æ€§ã®ãŸã‚è¦ç‚¹ã®ã¿ï¼‰ï¼š
   - 10x20ã®æ•´æ•°ã‚°ãƒªãƒƒãƒ‰ã§å½“ãŸã‚Šåˆ¤å®šã‚’ç°¡æ½”ã«ã€‚
   - 1ãƒ•ãƒ¬ãƒ¼ãƒ æ¯ã®æç”»ã¯å·®åˆ†ã§ã¯ãªãå…¨æç”»ï¼ˆç°¡æ½”ãƒ»ååˆ†è»½ã„ï¼‰ã€‚
   - ãƒ–ãƒ­ãƒƒã‚¯ã®1ãƒã‚¹æç”»ã¯ã€Œè‰²ã”ã¨ã«ã‚ªãƒ•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã€ã—ã¦ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç¢ºä¿ã€‚
   - å…¥åŠ›ã¯Keyboard + Pointerï¼ˆé•·æŠ¼ã—ã¯setIntervalï¼‰ã€‚
   - ã‚´ãƒ¼ã‚¹ãƒˆè¡¨ç¤ºã€ãƒ›ãƒ¼ãƒ«ãƒ‰ã€ãƒã‚¯ã‚¹ãƒˆã€ãƒ¬ãƒ™ãƒ«/ã‚¹ãƒ†ãƒ¼ã‚¸åˆ¶ã€ç›®æ¨™ãƒ©ã‚¤ãƒ³ã§ã‚¯ãƒªã‚¢ã€‚
   ========================================================== */

(function(){
  // ====== å®šæ•°ãƒ»åŸºæœ¬çŠ¶æ…‹ ======
  const COLS = 10, ROWS = 20, CELL = 30; // 300x600
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d');
  const nextCv = document.getElementById('next').getContext('2d');
  const holdCv = document.getElementById('hold').getContext('2d');

  const elStage = document.getElementById('stage');
  const elTarget = document.getElementById('target');
  const elLines = document.getElementById('lines');
  const elScore = document.getElementById('score');
  const elStatus = document.getElementById('status');

  const overlay = document.getElementById('overlay');
  const overlayStart = document.getElementById('overlayStart');
  const btnStart = document.getElementById('btnStart');
  const btnPause = document.getElementById('btnPause');
  const btnRestart = document.getElementById('btnRestart');

  // ã‚¹ãƒ†ãƒ¼ã‚¸æ§‹æˆï¼ˆã‚¯ãƒªã‚¢æ¡ä»¶ãƒ©ã‚¤ãƒ³æ•°ã¨è½ä¸‹ãƒ™ãƒ¼ã‚¹é€Ÿåº¦msï¼‰
  const STAGES = [
    { target:10, speed:700 },
    { target:16, speed:600 },
    { target:22, speed:520 },
    { target:28, speed:450 },
    { target:36, speed:380 },
  ];

  // ãƒ†ãƒˆãƒ­ãƒŸãƒå®šç¾©ï¼ˆå›è»¢ã¯è¡Œåˆ—å›è»¢ã§å¯¾å¿œï¼‰
  const SHAPES = {
    I: [[1,1,1,1]],
    O: [[1,1],[1,1]],
    T: [[0,1,0],[1,1,1]],
    S: [[0,1,1],[1,1,0]],
    Z: [[1,1,0],[0,1,1]],
    J: [[1,0,0],[1,1,1]],
    L: [[0,0,1],[1,1,1]],
  };
  // ãµã‚“ã‚ã‚Šãƒ‘ã‚¹ãƒ†ãƒ«ã‚«ãƒ©ãƒ¼
  const COLORS = {
    I:'#7adfff', O:'#ffd86b', T:'#ff9de6',
    S:'#9ff4a3', Z:'#ff9f9f', J:'#8fa8ff', L:'#ffc58f',
    GHOST:'#00000022' // ã‚´ãƒ¼ã‚¹ãƒˆ
  };

  // ä¹±æ•°ãƒãƒƒã‚°ï¼ˆ7ç¨®1å·¡ï¼‰â€”â€” åã‚Šé˜²æ­¢
  class Bag {
    constructor(){ this.b=[]; }
    next(){
      if(this.b.length===0){
        this.b = Object.keys(SHAPES);
        for(let i=this.b.length-1;i>0;i--){
          const j = Math.random()* (i+1) |0;
          [this.b[i],this.b[j]]=[this.b[j],this.b[i]];
        }
      }
      return this.b.pop();
    }
  }

  // ã‚²ãƒ¼ãƒ çŠ¶æ…‹
  let grid, cur, nextPiece, holdPiece=null, canHold=true;
  let score, lines, stageIndex, level, target, fallMs, lastFall=0, paused=false, over=false, started=false;

  // è‰²â†’ã‚ªãƒ•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚¿ã‚¤ãƒ«ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼ˆæç”»è² è·è»½æ¸›ï¼‰
  const tileCache = new Map();
  function getTile(color){
    if(tileCache.has(color)) return tileCache.get(color);
    const off = document.createElement('canvas');
    off.width = CELL; off.height = CELL;
    const c = off.getContext('2d');
    // è§’ä¸¸ã£ã½ã„ç«‹ä½“ã‚°ãƒ©ãƒ‡
    const r = 6;
    c.fillStyle = color;
    roundRect(c, 1,1, CELL-2, CELL-2, r);
    c.fill();
    c.globalAlpha = .12; // å…‰æ²¢
    c.fillStyle = '#fff';
    roundRect(c, 3,3, CELL-6, (CELL-6)/2, r);
    c.fill();
    c.globalAlpha = 1;
    c.strokeStyle = '#00000010';
    c.stroke();
    tileCache.set(color, off);
    return off;
  }
  function roundRect(c, x,y,w,h,r){
    c.beginPath();
    c.moveTo(x+r,y);
    c.arcTo(x+w,y,x+w,y+h,r);
    c.arcTo(x+w,y+h,x,y+h,r);
    c.arcTo(x,y+h,x,y,r);
    c.arcTo(x,y,x+w,y,r);
    c.closePath();
  }

  // ãƒ”ãƒ¼ã‚¹ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
  function newPiece(type){
    const m = SHAPES[type].map(row=>row.slice());
    return { type, m, x: (COLS/2 |0) - (m[0].length/2 |0), y: -2 };
  }
  function rotate(mat, dir){
    // dir=1:å³å›è»¢, -1:å·¦å›è»¢
    const h = mat.length, w = mat[0].length;
    const res = Array.from({length:w}, _=> Array(h).fill(0));
    for(let y=0;y<h;y++){
      for(let x=0;x<w;x++){
        if(dir>0) res[x][h-1-y]=mat[y][x];
        else      res[w-1-x][y]=mat[y][x];
      }
    }
    return res;
  }

  // ====== åˆæœŸåŒ–ãƒ»ãƒªã‚¹ã‚¿ãƒ¼ãƒˆ ======
  function init(){
    grid = Array.from({length:ROWS}, _=> Array(COLS).fill(''));
    score=0; lines=0; stageIndex=0; level=0; over=false; paused=false; started=false;
    setStage(0);
    const bag = new Bag();
    nextPiece = newPiece(bag.next());
    cur = newPiece(bag.next());
    // æ¬¡ãƒ”ãƒ¼ã‚¹ç”Ÿæˆç”¨ã«ãƒãƒƒã‚°ã‚’ä¿æŒ
    init.nextBag = bag;
    canHold=true;
    lastFall=0;
    updateHUD();
    drawAll(0); // åˆæœŸæç”»
  }
  function setStage(i){
    stageIndex = Math.min(i, STAGES.length-1);
    target = STAGES[stageIndex].target;
    fallMs = STAGES[stageIndex].speed;
    elStage.textContent = `Stage ${stageIndex+1}`;
    elTarget.textContent = `Target: ${target} lines`;
  }

  // ====== å…¥åŠ›å‡¦ç† ======
  const keys = Object.create(null);
  window.addEventListener('keydown', e=>{
    if(e.repeat) return;
    if(e.key==='ArrowLeft'){ move(-1); }
    else if(e.key==='ArrowRight'){ move(1); }
    else if(e.key==='ArrowUp'){ rotateCur(1); }
    else if(e.key==='z' || e.key==='Z'){ rotateCur(-1); }
    else if(e.key==='x' || e.key==='X'){ rotateCur(1); }
    else if(e.key==='ArrowDown'){ softDrop(); }
    else if(e.code==='Space'){ hardDrop(); }
    else if(e.key==='c' || e.key==='C'){ holdSwap(); }
    else if(e.key==='p' || e.key==='P'){ togglePause(); }
    else if(e.key==='r' || e.key==='R'){ restart(); }
  }, {passive:true});

  // ãƒ¢ãƒã‚¤ãƒ«ãƒœã‚¿ãƒ³ï¼ˆé•·æŠ¼ã—å¯¾å¿œï¼‰
  const pad = document.getElementById('pad');
  const holdTimers = new Map();
  function pressAction(action){
    if(action==='left') move(-1);
    else if(action==='right') move(1);
    else if(action==='rotL') rotateCur(-1);
    else if(action==='rotR') rotateCur(1);
    else if(action==='soft') softDrop();
    else if(action==='hard') hardDrop();
  }
  pad.addEventListener('pointerdown', e=>{
    const t = e.target.closest('[data-action]'); if(!t) return;
    e.preventDefault();
    pressAction(t.dataset.action);
    // é•·æŠ¼ã—ã§é€£æ‰“
    const id = setInterval(()=>pressAction(t.dataset.action), 110);
    holdTimers.set(e.pointerId, id);
    if(navigator.vibrate) navigator.vibrate(10);
  });
  pad.addEventListener('pointerup', e=>{
    const id = holdTimers.get(e.pointerId);
    if(id){ clearInterval(id); holdTimers.delete(e.pointerId); }
  });
  pad.addEventListener('pointercancel', e=>{
    const id = holdTimers.get(e.pointerId);
    if(id){ clearInterval(id); holdTimers.delete(e.pointerId); }
  });

  // ã‚µã‚¤ãƒ‰ãƒœã‚¿ãƒ³
  btnStart.addEventListener('click', startGame);
  overlayStart.addEventListener('click', startGame);
  btnPause.addEventListener('click', togglePause);
  btnRestart.addEventListener('click', restart);

  function startGame(){
    if(started) return;
    started=true; over=false; paused=false;
    overlay.style.display='none';
    elStatus.textContent='Playing';
    requestAnimationFrame(loop);
  }
  function togglePause(){
    if(!started || over) return;
    paused = !paused;
    elStatus.textContent = paused ? 'Paused' : 'Playing';
  }
  function restart(){
    init();
    overlay.style.display='none';
    startGame();
  }

  // ====== ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ======
  function collide(m, px, py){
    for(let y=0;y<m.length;y++){
      for(let x=0;x<m[0].length;x++){
        if(!m[y][x]) continue;
        const gx = px + x, gy = py + y;
        if(gx<0 || gx>=COLS || gy>=ROWS) return true;
        if(gy>=0 && grid[gy][gx]) return true;
      }
    }
    return false;
  }
  function lockPiece(){
    const {m,x,y,type} = cur;
    for(let j=0;j<m.length;j++){
      for(let i=0;i<m[0].length;i++){
        if(m[j][i]){
          const gy = y+j, gx=x+i;
          if(gy>=0) grid[gy][gx] = COLORS[type];
          else { // ç›¤å¤–ã«ãƒ­ãƒƒã‚¯ï¼ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
            gameOver(); return;
          }
        }
      }
    }
    // ãƒ©ã‚¤ãƒ³æ¶ˆå»
    let cleared=0;
    for(let r=ROWS-1;r>=0;r--){
      if(grid[r].every(v=>v)){
        grid.splice(r,1);
        grid.unshift(Array(COLS).fill(''));
        cleared++; r++;
      }
    }
    if(cleared){
      lines += cleared;
      score += [0,100,300,500,800][cleared] * (1+stageIndex*0.2 + level*0.1);
      if(lines >= target){
        // ã‚¹ãƒ†ãƒ¼ã‚¸ã‚¯ãƒªã‚¢
        stageIndex++;
        setStage(stageIndex);
        lines = 0;
        level++;
        elStatus.textContent = `Stage ${stageIndex} Clear!`;
        // è½ä¸‹é€Ÿåº¦ã‚‚å°‘ã—é€Ÿã‚ã‚‹
        fallMs = Math.max(140, fallMs-60);
      }
    }
    // æ¬¡ã¸
    if(!init.nextBag) init.nextBag = new Bag();
    cur = nextPiece;
    nextPiece = newPiece(init.nextBag.next());
    canHold=true;
  }
  function move(dx){
    if(!started || paused || over) return;
    const nx = cur.x + dx;
    if(!collide(cur.m, nx, cur.y)){ cur.x = nx; }
  }
  function rotateCur(dir){
    if(!started || paused || over) return;
    const rm = rotate(cur.m, dir);
    // ç°¡æ˜“SRS: ä¸­å¤®/å·¦å³ã«1ãƒã‚¹ãšã‚‰ã—ã¦ã¿ã‚‹
    const kicks = [0, -1, 1, -2, 2];
    for(const k of kicks){
      if(!collide(rm, cur.x+k, cur.y)){ cur.m = rm; cur.x += k; return; }
    }
  }
  function softDrop(){
    if(!started || paused || over) return;
    if(!collide(cur.m, cur.x, cur.y+1)){ cur.y++; score+=1; }
    else { lockPiece(); }
  }
  function hardDrop(){
    if(!started || paused || over) return;
    while(!collide(cur.m, cur.x, cur.y+1)){ cur.y++; score+=2; }
    lockPiece();
  }
  function holdSwap(){
    if(!started || paused || over || !canHold) return;
    const t = cur.type;
    if(holdPiece==null){
      holdPiece = t;
      cur = nextPiece;
      nextPiece = newPiece(init.nextBag.next());
    }else{
      const temp = holdPiece;
      holdPiece = t;
      cur = newPiece(temp);
    }
    cur.x = (COLS/2 |0) - (cur.m[0].length/2 |0);
    cur.y = -2;
    canHold=false;
    drawMini(holdCv, holdPiece);
  }
  function gameOver(){
    over = true; started=false;
    elStatus.textContent='Game Over';
    overlay.style.display='flex';
    overlay.querySelector('h2').textContent = 'Game Over!';
    overlay.querySelector('p').textContent = 'â†» Restart ã§å†æŒ‘æˆ¦ã—ã‚ˆã†ã€‚';
  }

  // ====== ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— ======
  function loop(ts){
    if(!started) return;
    if(!paused && !over){
      if(!lastFall) lastFall = ts;
      if(ts - lastFall >= fallMs){
        if(!collide(cur.m, cur.x, cur.y+1)){ cur.y++; }
        else { lockPiece(); }
        lastFall = ts;
      }
      drawAll(ts);
      updateHUD();
    }
    requestAnimationFrame(loop);
  }

  // ====== æç”» ======
  function drawAll(){
    // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ç›¤é¢ã«ãƒ•ã‚£ãƒƒãƒˆï¼ˆCSSæ‹¡å¤§ã¼ã‘é˜²æ­¢ï¼‰
    fitCanvas();

    // ç›¤é¢
    ctx.clearRect(0,0,canvas.width,canvas.height);
    // ã‚°ãƒªãƒƒãƒ‰æç”»
    for(let y=0;y<ROWS;y++){
      for(let x=0;x<COLS;x++){
        if(grid[y][x]){
          ctx.drawImage(getTile(grid[y][x]), x*CELL, y*CELL);
        }else{
          // è–„ã„ãƒ‰ãƒƒãƒˆ
          ctx.globalAlpha=.05;
          ctx.fillStyle='#000';
          ctx.fillRect(x*CELL+CELL/2-1, y*CELL+CELL/2-1, 2,2);
          ctx.globalAlpha=1;
        }
      }
    }
    // ã‚´ãƒ¼ã‚¹ãƒˆ
    let gy = cur.y;
    while(!collide(cur.m, cur.x, gy+1)) gy++;
    ctx.globalAlpha=0.35;
    drawMatrix(cur.m, cur.x, gy, COLORS.GHOST, true);
    ctx.globalAlpha=1;
    // ç¾åœ¨ãƒ”ãƒ¼ã‚¹
    drawMatrix(cur.m, cur.x, cur.y, COLORS[cur.type]);

    // ãƒã‚¯ã‚¹ãƒˆ/ãƒ›ãƒ¼ãƒ«ãƒ‰
    drawMini(nextCv, nextPiece.type);
    drawMini(holdCv, holdPiece);
  }
  function drawMatrix(m, px, py, color, ghost=false){
    for(let y=0;y<m.length;y++){
      for(let x=0;x<m[0].length;x++){
        if(!m[y][x]) continue;
        const dx = (px+x)*CELL, dy=(py+y)*CELL;
        if(ghost){
          ctx.fillStyle = color;
          ctx.fillRect(dx+4, dy+4, CELL-8, CELL-8);
        }else{
          ctx.drawImage(getTile(color), dx, dy);
        }
      }
    }
  }
  function drawMini(c, type){
    const cvs = c.canvas;
    c.clearRect(0,0,cvs.width,cvs.height);
    if(!type) return;
    const m = SHAPES[type];
    // ä¸­å¤®é…ç½®
    const w = m[0].length, h = m.length;
    const cell = Math.floor(Math.min(cvs.width/(w+1), cvs.height/(h+1)));
    const ox = (cvs.width - w*cell)/2;
    const oy = (cvs.height - h*cell)/2;
    // ç°¡æ˜“ã‚¿ã‚¤ãƒ«
    c.fillStyle='#f8f8ff';
    c.fillRect(0,0,cvs.width,cvs.height);
    for(let y=0;y<h;y++){
      for(let x=0;x<w;x++){
        if(!m[y][x]) continue;
        const off = getMiniTile(COLORS[type], cell);
        c.drawImage(off, ox+x*cell, oy+y*cell);
      }
    }
  }
  const miniCache = new Map();
  function getMiniTile(color, cell){
    const key = color+'_'+cell;
    if(miniCache.has(key)) return miniCache.get(key);
    const off = document.createElement('canvas'); off.width=cell; off.height=cell;
    const c = off.getContext('2d');
    c.fillStyle=color; roundRect(c,1,1,cell-2,cell-2, Math.max(2,cell*0.2)); c.fill();
    c.globalAlpha=.15; c.fillStyle='#fff';
    roundRect(c,2,2,cell-4,(cell-4)/2, Math.max(2,cell*0.2)); c.fill(); c.globalAlpha=1;
    miniCache.set(key, off); return off;
  }

  // HUDæ›´æ–°
  function updateHUD(){
    elLines.textContent = `Lines: ${lines}`;
    elScore.textContent = `Score: ${Math.floor(score)}`;
  }

  // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆï¼šã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ãƒ‡ãƒã‚¤ã‚¹å¹…ã«ãƒ•ã‚£ãƒƒãƒˆ
  function fitCanvas(){
    const maxBoardWidth = Math.min( (window.innerWidth>800 ? 300 : window.innerWidth*0.9 - 140), 360 );
    const scale = Math.max(1, Math.floor(maxBoardWidth / (COLS* (CELL/1)) ));
    canvas.width = COLS*CELL; canvas.height = ROWS*CELL;
    canvas.style.width = (COLS*CELL* (scale/1))+'px';
    canvas.style.height = (ROWS*CELL* (scale/1))+'px';
  }
  window.addEventListener('resize', fitCanvas, {passive:true});
  window.addEventListener('orientationchange', fitCanvas, {passive:true});

  // ====== ã‚²ãƒ¼ãƒ é–‹å§‹æº–å‚™ ======
  init();

  // ä½¿ã„ã‚„ã™ã•ï¼šã‚­ãƒ£ãƒ³ãƒã‚¹ã‚„ãƒœã‚¿ãƒ³ã‚¿ãƒƒãƒ—ã§ã‚‚é–‹å§‹
  canvas.addEventListener('pointerdown', ()=>{ if(!started) startGame(); });

})();
</script>
</body>
</html>
